---
title: "React ìƒíƒœê´€ë¦¬"
categories:
  - React
tag: [React, TS]
---

# 24/09/30 - ì´ë“ /React Deep Dive 5,6ì¥

# 5ì¥

## 5.1 ìƒíƒœê´€ë¦¬ ì™œ í•„ìš”í•¨?

ìƒíƒœë€ ë¬´ì—‡ì¸ê°€?

### reactì˜ ìƒíƒœ ê´€ë¦¬ ì—­ì‚¬

> Flux íŒ¨í„´

ê·¸ëŸ¬í•˜ë‹¤!

> Redux ë“±ì¥

Flux êµ¬ì¡°ë¥¼ ìœ„í•´ Elm ì•„í‚¤í…ì²˜ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë§Œë“¤ì–´ì§„ ìƒíƒœê´€ë¦¬ ë¼ì´ë¸ŒëŸ¬ë¦¬

> Elmì´ ë­ì„?

fluxì™€ ë§ˆì°¬ê°€ì§€ë¡œ ë°ì´í„° íë¦„ì„ 3ê°€ì§€ë¡œ ë¶„ë¥˜ í›„ ë‹¨ë°©í–¥ìœ¼ë¡œ ê°•ì œ ì‹œí‚´

- ëª¨ë¸ : ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ìƒíƒœ
- ë·° : ëª¨ë¸ì„ í‘œí˜„í•˜ëŠ” HTML
- ì—…ë°ì´íŠ¸ : ëª¨ë¸(ìƒíƒœ)ë¥¼ ìˆ˜ì •í•˜ëŠ” ë°©ì‹

ì´ë ‡ê²Œ ìƒíƒœ ì—…ë°ì´íŠ¸ë¥¼ ë‹¨ë°©í–¥ìœ¼ë¡œ ê°•ì œì‹œí‚´

ReduxëŠ” Elm ì•„í‚¤í…ì²˜ì˜ ì˜í–¥ìœ¼ë¡œ

ìŠ¤í† ì–´ : í•˜ë‚˜ì˜ ìƒíƒœ ê°ì²´ë¥¼ ë‹´ê³ ìˆìŒ

ë””ìŠ¤íŒ¨ì¹˜ : reducer í•¨ìˆ˜ë¡œ ìŠ¤í† ì–´ì˜ ìƒíƒœë¥¼ ì—…ë°ì´íŠ¸ í•¨ ì´ë•Œ ìƒˆë¡œìš´ ê°ì²´ë¥¼ ë§Œë“¤ì–´ì„œ ì „íŒŒí•¨

ë¡œ ë‚˜ëˆ ì„œ ì‚¬ìš©í•¨

ë‹¨ì  : í• ê²Œ ë§ë‹¤(ì•¡ì…˜ íƒ€ì… ì„ ì–¸, ì•¡ì…˜ ìˆ˜í–‰í•¨ìˆ˜ êµ¬í˜„,dispatcher, selector í•„ìš”, â€¦ ë³´ì¼ëŸ¬í”Œë ˆì´íŠ¸ê°€ ë„˜ ë§ìŒ)

> Context Apiì™€ useContext

props drillingì€ í”¼í•˜ê³  ì‹¶ì€ë° redux ë³´ì¼ëŸ¬í”Œë ˆì´íŠ¸ëŠ” ì‹«ì–´ â‡’ context API

ì´ˆì°½ê¸°ì—ëŠ” `getChildContext()`ë¥¼ í†µí•´ì„œ ì „ì—­ìƒíƒœë¥¼ ë¶ˆëŸ¬ë‹¤ ì¼ëŠ”ë° ë‘ê°€ì§€ ë¬¸ì œê°€ ìˆì—ˆìŒ

1. `getChildContext`ë¥¼ í˜¸ì¶œí•˜ë©´ `shouldComponentUpdate`ê°€ trueê°€ ë˜ì–´ ë¶ˆí•„ìš”í•œ ë Œë”ë§ ë°œìƒ
   1. `shouldComponentUpdate` ëŠ” booleanê°’ì„ ë°˜í™˜í•˜ëŠ”ë° props, stateê°€ ë³€ê²½ë˜ì—ˆì„ ë•Œ trueê°€ ë˜ë©´ì„œ render()ê°€ ì‹¤í–‰ë¨
2. contextë¥¼ ì¸ìˆ˜ë¡œ ë°›ì•„ì•¼ í•´ì„œ ê²°í•©ë„ í–¥ìƒ

ì°¸ê³  : https://legacy.reactjs.org/docs/legacy-context.html

ê·¸ë˜ì„œ ì´ëŸ° ë‹¨ì  í•´ê²°í•˜ë ¤ê³  16.3ë²„ì „ì— ìƒˆë¡œìš´ contextê°€ ì¶œì‹œë¨

- `createContext` : ì»¨íƒìŠ¤íŠ¸ ìƒì„±
- `createContext.Provider` : ì»¨í…ìŠ¤íŠ¸ ê³µê¸‰ì
- `createContext.Consumer` : ì»¨í…ìŠ¤íŠ¸ ì†Œë¹„ì(ë ˆê±°ì‹œ, class, í•˜ìœ„í˜¸í™˜ì„±)
  â‡’ `useContext(createContext)` : í›…ìœ¼ë¡œ ê°€ì ¸ì™€ì„œ ì†Œë¹„í•¨

ê·¼ë° Context APIëŠ” ìƒíƒœë¥¼ 'ê´€ë¦¬'í•˜ì§€ ì•ŠìŒ ê·¸ëƒ¥ 'ì£¼ì…'í•  ë¿ì„

ìƒíƒœê´€ë¦¬ ë¼ì´ë¸ŒëŸ¬ë¦¬ì˜ ì¡°ê±´ì´ ë  ìˆ˜ ìˆëŠ”

- ì–´ë–¤ ìƒíƒœë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë‹¤ë¥¸ ìƒíƒœë¥¼ ë§Œë“¤ ìˆ˜ ìˆì–´ì•¼ í•œë‹¤
- í•„ìš”ì— ë”°ë¼ ì´ëŸ° ìƒíƒœ ë³€í™”ë¥¼ ìµœì í™” í•  ìˆ˜ ìˆì–´ì•¼ í•œë‹¤

ë‘ê°€ì§€ ë‹¤ ë§Œì¡± ëª»í•¨ (p222/3.1ì¥)

â‡’ ìƒíƒœê´€ë¦¬ë¥¼ ìœ„í•œ APIê°€ ì•„ë‹˜

> React query, SWR íƒ„ìƒ

í•¨ìˆ˜ ì»´í¬ë„ŒíŠ¸ê°€ ì¸ê¸°ë¥¼ ëŒë©° ì—¬ëŸ¬ í›…ì´ ë‚˜ì˜´
â‡’ ì´ë•Œ ì»¤ìŠ¤í…€ í›…ì„ í†µí•´ ìì‹ ë“¤ë§Œì˜ í›…ë“¤ì„ ë§Œë“¤ê¸° ì‹œì‘í•¨

â‡’ ê·¸ì¤‘ ëŒ€í‘œì ì¸ ì»¤ìŠ¤í…€ í›…ì´ React Query, SWRì„

ë‘˜ë‹¤ fetchê´€ë¦¬ì— íŠ¹í™”ëœ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¼ ì„œë²„ìƒíƒœ(HTTPìš”ì²­)ê´€ë¦¬ì— íŠ¹í™”ë¨ (loading, error, data, â€¦)

<aside>
ğŸ’¡

ì‹œê°„ë‚˜ë©´ TanStack Query/coreë„ ëœ¯ì–´ë³´ê¸° â‡’ ~~ì‹¤íŒ¨ã…‹ã…~~

</aside>

> Recoil, Zustand, Jotai, Valtio íƒ„ìƒ

Reduxì™€ëŠ” ë‹¤ë¥´ê²Œ í›…ì„ ì‚¬ìš©í•´ì„œ ì‘ì€ í¬ê¸°ì˜ ìƒíƒœë¥¼ íš¨ìœ¨ì ìœ¼ë¡œ ê´€ë¦¬í•˜ëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬ ë“¤ì´ ìŸì•„ì§

â‡’ ê·¸ë˜ì„œ ê¹Œë³´ë©´ ëª¨ë‘ peerDependenciesê°€ react V16.8 ì´ìƒì„

### 5.1.2 ì •ë¦¬

ì—¬ëŸ¬ ë¼ì´ë¸ŒëŸ¬ë¦¬(í•´ê²°ì±…)ë“¤ì´ ë‚˜ì˜¤ê³  ìˆìŒ â‡’ ì´ë¶„ì•¼ê°€ ê±´ê°•í•˜ë‹¤

â‡’ í•„ìš”ì— ë”°ë¼ ì•Œì˜ë”±ê¹”ì„¼í•˜ì

## 5.2ì¥ React hookìœ¼ë¡œ ìƒíƒœê´€ë¦¬ í•˜ê¸°

ì˜›ë‚ ì—ëŠ” Redux í•„ìˆ˜ì˜€ì§€ë§Œ ìš”ì¦˜ì—” ì„ íƒì„ <= Context API, useReducer, useState ë•ì„

<aside>
ğŸ’¡

ëª°ëë˜ ì‚¬ì‹¤ : useStateì˜ ë‚´ë¶€ êµ¬í˜„ì´ useRedcerë¡œ ë˜ì–´ìˆìŒ

</aside>

```tsx
type Init<T> = T extends any ? T | ((prev: T) => T) : never;

function useState<T>(init: T) {
  const [state, dispatch] = useReducer(
    (prev: T, action: Init<T>) =>
      typeof action === "function" ? action(prev) : action,
    init
  );

  return [state, dispatch];
}
```

(ë°˜ëŒ€ë„ ê°€ëŠ¥í•¨)

ë‘˜ ë‹¤ ë˜‘ê°™ì€ ë†ˆë“¤ì´ë‹¤

ê·¸ë˜ì„œ ë‘˜ ë‹¤ í•œê³„ê°€ ë™ì¼í•˜ë‹¤

â‡’ í›…ì„ ì‚¬ìš©í•  ë•Œë§ˆë‹¤ ì»´í¬ë„ŒíŠ¸ ë³„ë¡œ ì´ˆê¸°í™”ë˜ë¯€ë¡œ ê°ê° ë³„ê°œë¡œ ëŒì•„ê°„ë‹¤(local state)

â‡’ ê³µìœ ê°€ ì•ˆë¨ â‡’ ê·¸ë˜ì„œ propë¡œ ë„˜ê²¨ì¤Œ â‡’ props dirilling ë¹ ë°¤

**í•œê³„**

useState, useReducer ëª¨ë‘ ë¦¬ì•¡íŠ¸ì˜ fiber nodeì— ì—°ê²°ëœ hooks ì—°ê²° ë¦¬ìŠ¤íŠ¸ ì•ˆì— í´ë¡œì € ë˜ì–´ìˆë‹¤ â‡’ ë¦¬ì•¡íŠ¸ê°€ ê´€ë¦¬í•œë‹¤

ê·¸ëŸ¼ ë¦¬ì•¡íŠ¸ê°€ ê´€ë¦¬í•˜ì§€ ì•ŠëŠ” ê³³ì—ì„œ í´ë¡œì € ì‹œí‚¤ë©´?
â‡’ JS ì‹¤í–‰ ì»¨í…ìŠ¤íŠ¸ ì–´ë”˜ê°€ì—ì„œ ê´€ë¦¬í•˜ê³  ê·¸ê³³ì„ ì°¸ì¡°í•˜ê³  ìˆë‹¤ë©´?

### ì „ì—­ìƒíƒœê´€ë¦¬ ì§ì ‘ë§Œë“¤ì–´ë³´ê¸°

1. ì‹¤í–‰ ì»¨í…ìŠ¤íŠ¸ì— ì €ì¥í•œ ìƒíƒœê°ì²´ë¥¼ stateì— ë„£ì–´ì£¼ê³ 
2. setState ì‹œ ì‹¤í–‰ ì»¨í…ìŠ¤íŠ¸ì— ì €ì¥í•œ ìƒíƒœê°ì²´ë„ í•¨ê»˜ ë°”ê¿”ì¤€ë‹¤ë©´?

```tsx
// Store.ts
import React from "react";

export type State = { counter: number };

let state: State = {
  counter: 0,
};

export function get(): State {
  return state;
}

type Init<T> = T extends any ? T | ((prev: T) => T) : never;

export function set<T>(nextState: Init<T>) {
  state = typeof nextState === "function" ? nextState(state) : nextState;
}

// Counter1.tsx
function Counter1() {
  const [count, setCount] = useState(state);

  function handleClick() {
    set((prev: State) => {
      const newState = { counter: prev.counter + 1 };
      setCount(newState);
      return newState;
    });
  }

  return (
    <>
      <h3>{state.counter}</h3>
      <button onClick={handleClick}>+</button>
    </>
  );
}

// Counter2.tsx
function Counter2() {
  const [count, setCount] = useState(state);

  function handleClick() {
    set((prev: State) => {
      const newState = { counter: prev.counter + 1 };
      setCount(newState);
      return newState;
    });
  }

  return (
    <>
      <h3>{state.counter}</h3>
      <button onClick={handleClick}>+</button>
    </>
  );
}
```

ì“°ë ˆê¸° ì½”ë“œë¥¼ ì‘ì„±í–ˆìŠµë‹ˆë‹¤.

1. ë™ì¼í•œ ìƒíƒœë¥¼ ì¤‘ë³µìœ¼ë¡œ ê´€ë¦¬
2. ì°¸ì¡°í•˜ê³  ìˆëŠ” ë‹¤ë¥¸ ì»´í¬ë„ŒíŠ¸ëŠ” ì•¡ì…˜ìˆê¸° ì „ê¹Œì§€ ë Œë”ë§ ì•ˆí•¨

ê·¸ëŸ¼ ì œëŒ€ë¡œëœ ìŠ¤í† ì–´ë¥¼ ë§Œë“¤ëŸ¬ë©´?

1. ì»´í¬ë„ŒíŠ¸ ì™¸ë¶€ì— ì €ì¥
2. ë³€ê²½ ì‹œ ì‚¬ìš©í•˜ëŠ” ì»´í¬ë„ŒíŠ¸ê°€ ë¦¬ë Œë”ë§ ë˜ì•¼í•¨
3. ì‚¬ìš©í•˜ì§€ ì•ŠëŠ”ë‹¤ë©´ ë¦¬ë Œë”ë§ ë˜ì§€ ë§ì•„ì•¼í•¨

ì´ê²Œ ê°€ëŠ¥í•˜ê²Œ ìˆ˜ì •í•´ë³´ë©´

```tsx
// type.ts
export type Init<T> = T extends any ? T | ((prev: T) => T) : never;

export type Store<State> = {
  get: () => State; // ë§¤ë²ˆ ë³€ê²½ ë˜ë„ë¡
  set: (action: Init<State>) => State; // ustStateì™€ ë™ì¼
  subscribe: (callback: () => void) => () => void; // ë³€ê²½ì‹œ callback ì‹¤í–‰ë˜ë„ë¡
};
```

```tsx
// createStore.tsx
import { Init, Store } from "./type";

export const CreateStore = <State extends unknown>(
  init: Init<State>
): Store<State> => {
  let state = typeof init === "function" ? init() : init;

  const callbacks = new Set<() => void>();

  const get = () => state;

  const set = (nextState: State | ((prev: State) => State)) => {
    state =
      typeof nextState === "function"
        ? (nextState as (prev: State) => State)(state)
        : nextState;

    callbacks.forEach((cb) => cb());

    return state;
  };

  const subscribe = (callback: () => void) => {
    callbacks.add(callback);

    return () => {
      callbacks.delete(callback);
    };
  };

  return { get, set, subscribe };
};

export default CreateStore;
```

```tsx
// useStore.ts
import { useEffect, useState } from "react";
import { Store } from "../type";

export const useStore = <State extends unknown>(store: Store<State>) => {
  const [state, setState] = useState<State>(() => store.get());

  useEffect(() => {
    const unsubscribe = store.subscribe(() => setState(store.get()));

    return unsubscribe;
  }, [store]);

  return [state, store.set] as const;
};
```

ì´ë ‡ê²Œ 1, 2ì˜ ë¬¸ì œë¥¼ í•´ê²° í•  ìˆ˜ ìˆë‹¤. í•˜ì§€ë§Œ ì´ëŒ€ë¡œëŠ” ì»´í¬ë„ŒíŠ¸ê°€ storeì—ì„œ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ê°’ì´ ë³€ê²½ë ë•Œë„ ë¦¬ë Œë”ë§ ë˜ë¯€ë¡œ 3ë²ˆì— ë¶€í•©í•˜ë‹¤.

```tsx
// useStoreSelector.ts
import { useEffect, useState } from "react";
import { Store } from "../type";

export const useStoreSelector = <State extends unknown, Value extends unknown>(
  store: Store<State>,
  selector: (state: State) => Value
) => {
  const [state, setState] = useState(() => selector(store.get()));

  useEffect(() => {
    const unsubscribe = store.subscribe(() => {
      const value = selector(store.get());
      setState(value);
    });

    return unsubscribe;
  }, [store, selector]);

  return [state, store.set] as const;
};
```

ì´ë ‡ê²Œ ì‚¬ìš©í•˜ëŠ” storeë§Œ ìˆ˜ì • ì‹œ ë¦¬ë Œë”ë§ ì‹œì¼œì£¼ëŠ” ë°©ë²•ìœ¼ë¡œ ë³€ê²½í•´ì£¼ë©´ í•„ìš”ì—†ëŠ” ê³³ì€ ë³€ê²½ë˜ì§€ ì•ŠëŠ”ë‹¤.

(ì£¼ì˜í•  ì ì€ selectorë¥¼ ì»´í¬ë„ŒíŠ¸ ë°–ì—ì„œ ì„ ì–¸í•˜ê±°ë‚˜ useCallbackìœ¼ë¡œ ê°ì‹¸ì¤˜ì•¼ í•©ë‹ˆë‹¤. ì•ˆê·¸ëŸ¬ë©´ ë¦¬ë Œë”ë§ ë  ë•Œë§ˆë‹¤ í•¨ìˆ˜ê°€ ë‹¤ì‹œ ìƒì„±ë˜ë©° subscribeë¥¼ ë°˜ë³µí•˜ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤ â‡’ ì´ëŠ” useSyncExternalStoreì—ì„œgetSnapshot ë™ì‘ê³¼ ë¹„ìŠ·í•œë° ì—¬ê¸°ëŠ” ë‚´ë¶€ì—ì„œ ë©”ëª¨ì´ì œì´ì…˜ ì²˜ë¦¬ë¥¼ í•´ì¤ë‹ˆë‹¤.)

demoë³´ê³  ì˜¤ì‹œì£ ì‰

[á„’á…ªá„†á…§á†« á„€á…µá„…á…©á†¨ 2024-09-27 á„‹á…©á„’á…® 5.48.14.mov](/images/2024-09-30-2024-09-30-01/demo.mov)

count1, 2ëŠ” useStoreë¥¼ ì‚¬ìš©í•œ ì»´í¬ë„ŒíŠ¸ë¡œ ìŠ¤í† ì–´ê°€ ì—…ë°ì´íŠ¸ ë  ë•Œ í•­ìƒ ë¦¬ë Œë”ë§ ë˜ì§€ë§Œ

count3, nameì€ useSelectorë¥¼ ì‚¬ìš©í•œ ì»´í¬ë„ŒíŠ¸ë¡œ ìì‹ ì´ ì‚¬ìš©í•œ ìŠ¤í† ì–´ ê°’ì´ ì—…ë°ì´íŠ¸ ë  ë•Œë§Œ ë¦¬ë Œë”ë§ ë˜ëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆë‹¤.

ì´ì™€ ë™ì¼í•œ ì—­í• ì„í•˜ëŠ” reactì˜ í›…ì´ [useSubscription](https://github.com/facebook/react/blob/main/packages/use-subscription/src/useSubscription.js)ì´ë‹¤.

ê·¼ë° v18 ì´ìƒë¶€í„°ëŠ” ë‚´ë¶€ êµ¬í˜„ì´ `useSyncExternalStore`ë¡œ ë˜ì–´ìˆë‹¤. (ì´ì „êº¼ëŠ” ì•ˆê¹Œë³´ê² ìŠµë‹ˆë‹¤â€¦)

ì‹¤ì œ ë™ì‘ì€ [useSyncExternalStoreShimClient](https://github.com/facebook/react/blob/main/packages/use-sync-external-store/src/useSyncExternalStoreShimClient.js)ì—ì„œ í™•ì¸ ê°€ëŠ¥í•˜ë‹¤

v18ë¶€í„° ë‚˜ëˆ ì§„ ì´ìœ ë¥¼ ì°¾ì•„ë³´ë©´ 'ë™ì‹œì„±' ì´ë¼ëŠ” ê²°ë¡ ì— ë„ë‹¬í•œë‹¤.

ì—¬ê¸°ë¶€í„°ëŠ” í•  ì´ì•¼ê¸° ë§ë‹¤â€¦ ë–¡ë°¥ë§Œ ë˜ì ¸ë†“ê³  ì „ì—­ìƒíƒœê´€ë¦¬ë¥¼ ì´ì–´ë‚˜ê°€ë³´ìâ€¦

ê·¸ëŸ¬ë©´ ëª¨ë“  ë¬¸ì œê°€ í•´ê²°ëœê²ƒì¸ê°€?!

í•„ìëŠ” ì•„ì‰½ê²Œë„ ì•„ë‹ˆë¼ê³  í•œë‹¤..

> ìƒˆë¡œìƒê¸´ ë¬¸ì œ : ì´ í›…ê³¼ ìŠ¤í† ì–´ë¥¼ ì‚¬ìš©í•˜ëŠ” êµ¬ì¡°ì—ì„œëŠ” ë°˜ë“œì‹œ í•˜ë‚˜ì˜ ìŠ¤í† ì–´ë§Œ ê°€ì§€ê²Œ ëœë‹¤.

ë¬¼ë¡ 

```tsx
const store1 = createStore({ count: 0 });
const store2 = createStore({ count: 0 });
const store3 = createStore({ count: 0 });
```

ì´ëŸ°ì‹ìœ¼ë¡œ ìŠ¤í† ì–´ë¥¼ ì—¬ëŸ¬ê°œ ë§Œë“¤ ìˆ˜ë„ ìˆë‹¤.
ê·¸ë¦¬ê³  í›…ê³¼ ìŠ¤í† ì–´ê°€ 1:1ë¡œ ì˜ì¡´ê´€ê³„ë¥¼ ê°€ì§€ê³  ìˆê¸° ë•Œë¬¸ì— ì´ ìŠ¤í† ì–´ë¥¼ ë°”ë¼ë³´ëŠ” useStoreë¥¼ ê°ê° ë§Œë“¤ì–´ ì£¼ë©´ ê°€ëŠ¥ì€ í•˜ë‹¤.

```tsx
const Count1 = () => {
	const [state1, setState1] = useStore(store1);
	const [state2, setState2] = useStore(store2);
	const [state3, setState3] = useStore(store3);

	...
}
```

í•˜ì§€ë§Œ ì´ëŸ° êµ¬ì¡°ëŠ” ì¸ìë¡œ ë„˜ê²¨ì£¼ëŠ” storeê°€ ì–´ë””ì— ë“¤ì–´ê°€ëŠ”ì§€ ê°ê° ê´€ë¦¬í•˜ë©° store1, 2, 3ì— ì–´ë–¤ ê°’ì´ ë‹´ê²¨ ìˆëŠ”ì§€ ê¸°ì–µí•´ì•¼í•œë‹¤

â‡’ ì´ê²ƒì„ ë¬¸ì œë¼ê³  ì¸ì‹í•œë‹¤ë©´ ì–´ë–»ê²Œ í•´ê²°í•  ìˆ˜ ìˆì„ê¹Œ?

â‡’ ì´ë ‡ê²Œ ë§í•œ ì´ìœ ëŠ” ë‚˜ëŠ” ì´ê²Œ ë¬¸ì œì¸ê°€? ë¼ëŠ” ìƒê°ì´ ì¡°ê¸ˆ ë“ ë‹¤.. ê°ê°ì˜ ì „ì—­ ìƒíƒœë³„ë¡œ storeë¥¼ ë‚˜ëˆ„ì–´ ê´€ë¦¬í•˜ëŠ”ê²Œ ë” í¸ë¦¬í•˜ë‹¤ê³  ìƒê°í•œë‹¤

ë‹¨, ìœ„ì˜ í˜•ì‹ì²˜ëŸ¼ useStoreë¥¼ ìƒì„±ì´ ì•„ë‹Œ ë‹¤ë¥¸ ìƒíƒœê´€ë¦¬ ë¼ì´ë¸ŒëŸ¬ë¦¬ì²˜ëŸ¼ useCount, useName ì´ëŸ° ì‹ìœ¼ë¡œ ì»¤ìŠ¤í…€ í›… ë‚´ë¶€ì— useStoreë¥¼ ì‚¬ìš©í•´ì„œ ìŠ¤í† ì–´ë¥¼ ë§Œë“¤ê³  ì‚¬ìš©í•˜ëŠ” ê³³ì—ì„œ ê°ê°ì˜ ìŠ¤í† ì–´ë¥¼ í˜¸ì¶œ í•˜ëŠ”ì‹ìœ¼ë¡œ í•´ê²°í•˜ë©´ ë˜ì§€ ì•Šì„ê¹Œ ì‹¶ì—ˆë‹¤.

### 5.2.3 useStateì™€ Contextë¥¼ í•¨ê»˜ ì‚¬ìš©í•´ ì „ì—­ìƒíƒœê´€ë¦¬ ë§Œë“¤ì–´ë³´ê¸°

ì—¬ê¸°ì„œ Contextë¥¼ ë„ì…í•˜ë©´ ìœ„ì˜ ë¬¸ì œë¥¼ í•´ê²° í•  ìˆ˜ ìˆë‹¤.

```tsx
// CounterStoreProvider.tsx
export type CounterStore = { count: number; text: string };
export const CounterStoreContext = createContext<Store<CounterStore>>(
  createStore<CounterStore>({ count: 1, text: "ì´ˆê¸°ê°’ê°’" })
);

export const CounterStoreProvider = ({
  initialState,
  children,
}: PropsWithChildren<{ initialState: CounterStore }>) => {
  // useRefë¡œ í•˜ëŠ” ì´ìœ ëŠ” Providerë¡œ ë„˜ê²¨ì£¼ëŠ” propsê°€ ë¶ˆí•„ìš”í•˜ê²Œ ë³€ê²½ë¼ì„œ ë¦¬ë Œë”ë§ ë˜ëŠ” ê²ƒì„ ë°©ì§€í•œ ê²ƒìœ¼ë¡œ
  // ì´ë ‡ê²Œ í–ˆì„ ë•Œ ìµœì´ˆ ë Œë”ë§ì—ì„œë§Œ ìŠ¤í† ì–´ë¥¼ ë§Œë“¤ì–´ì„œ ê°’ì„ ë‚´ë ¤ì¤„ ê²ƒì´ë‹¤.
  const storeRef = useRef<Store<CounterStore>>();

  // ìŠ¤í† ì–´ë¥¼ ìƒì„±í•œ ì ì´ ì—†ìœ¼ë©´ ìµœì´ˆì— í•œ ë²ˆ ìƒì„±í•¨
  if (!storeRef.current) {
    storeRef.current = createStore(initialState);
  }

  return (
    <CounterStoreContext.Provider value={storeRef.current}>
      {children}
    </CounterStoreContext.Provider>
  );
};
```

ì´ë ‡ê²Œ Contextë¥¼ ì‚¬ìš©í•´ì„œ Providerë¥¼ ë§Œë“¤ì–´ì£¼ê³ 

```tsx
// useCounterContextSelector.ts
export const useCounterContextSelector = <State extends unknown>(
  selector: (store: CounterStore) => State
) => {
  const store = useContext(CounterStoreContext);

  // useSubscription
  const [subscription, _] = useStoreSelector(store, useCallback(selector, []));

  return [subscription, store.set] as const;
};
```

useContextë¥¼ ì‚¬ìš©í•´ì„œ CounterStoreê°’ì„ í•¸ë“¤ë§ í•´ì£¼ë©´

(ì±…ì—ëŠ” useSubscriptionìœ¼ë¡œ êµ¬í˜„ë˜ì–´ìˆìŒ - feea6b22)

```tsx
function NavigationBar() {
  return (
    <>
      <ContextCounter />
      <ContextInput />

      <CounterStoreProvider initialState={{ count: 2, text: "ë‘ë²ˆì§¸" }}>
        <ContextCounter />
        <ContextInput />

        <CounterStoreProvider initialState={{ count: 3, text: "ì„¸ë²ˆì§¸" }}>
          <ContextCounter />
          <ContextInput />
        </CounterStoreProvider>
      </CounterStoreProvider>

      <CounterStoreProvider initialState={{ count: 4, text: "ë„¤ë²ˆì¨°" }}>
        <ContextCounter />
        <ContextInput />
      </CounterStoreProvider>
    </>
  );
}
```

ì´ë ‡ê²Œ storeë¥¼ ì‚¬ìš©í•  êµ¬ì—­ë³„ë¡œ ê´€ë¦¬í•´ì„œ storeë¥¼ ì§€ì •í•˜ê³  ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤. ì´ê±¸ë¡œ ì–»ê²Œ ë˜ëŠ” ì¥ì ì€

1. ìŠ¤í† ì–´ê°€ ì–´ë””ì„œ ì˜¨ê±´ì§€ ì‹ ê²½ ì•ˆì¨ë„ ë¨
2. contextì™€ providerë¥¼ ê´€ë¦¬í•˜ëŠ” ë¶€ëª¨ì…ì¥ì—ì„œëŠ” ìì‹ ì»´í¬ë„ŒíŠ¸ì— ë”°ë¼ ë³´ì—¬ì£¼ê³  ì‹¶ì€ ë°ì´í„°ë¥¼ contextë¡œ ì˜ ê²©ë¦¬í•˜ë©´ ë¨
3. ë¶€ëª¨ì™€ ìì‹ ì»´í¬ë„ŒíŠ¸ì˜ ì±…ì„ê³¼ ì—­í• ì„ ì´ë¦„ì´ ì•„ë‹Œ ëª…ì‹œì ì¸ ì½”ë“œë¡œ ë‚˜ëˆŒ ìˆ˜ ìˆì–´ ì½”ë“œ ì‘ì„±ì´ ìš©ì´í•´ì§

ë¼ê³  í•˜ëŠ”ë° 2, 3ì€ í¬ê²Œ ê³µê°ì€ ì•ˆëœë‹¤â€¦

ê·¸ë¦¬ê³  1ë²ˆì€ ìœ„ì˜ ìŠ¤í† ì–´ë³„ë¡œ useStoreë¥¼ ë§Œë“œëŠ” ê°ê°ì˜ í›…ì„ ë§Œë“¤ì–´ì„œ ê´€ë¦¬í•˜ëŠ”ê²Œ ë” ëª…ì‹œì ì´ê³  ì‚¬ìš©í•˜ê¸° í¸í•˜ì§€ ì•Šë‚˜? ë¼ê³  ìƒê°í•œë‹¤ recoil, zustand ëª¨ë‘ ê·¸ëŸ° ì‹ìœ¼ë¡œ ë§Œë“¤ì–´ì ¸ìˆê³ ..

### 5.2.4ì¥ Recoil, Jotai, Zustand ì‚´í´ë³´ê¸°

í˜„ì¬ ê°ê´‘ ë°›ê³  ìˆëŠ” 3ê°œì˜ ìƒíƒœê´€ë¦¬ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ë¹„êµí•´ë³´ì

Recoil, Jotail : context, Provider ê¸°ë°˜ìœ¼ë¡œ ê°€ëŠ¥í•œ ì‘ì€ ìƒíƒœë¥¼ ê´€ë¦¬

Zustand, Redux : í•˜ë‚˜ì˜ í° ìŠ¤í† ì–´ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ìƒíƒœë¥¼ ê´€ë¦¬ â‡’ context ê¸°ë°˜ì´ ì•„ë‹Œ ìŠ¤í† ì–´ê°€ ê°€ì§€ëŠ” í´ë¡œì €ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ìƒì„± + ìƒíƒœ ë³€ê²½ì‹œ êµ¬ë…í•˜ê³  ìˆëŠ” ì»´í¬ë„ŒíŠ¸ì— ì „íŒŒ

> Recoil

ìµœì†Œ ìƒíƒœ ê°œë…ì¸ atomì´ë¼ëŠ” ì´ë¡ ì„ ê°€ì¥ ë¨¼ì € ì„ ë³´ì˜€ìœ¼ë©° 20ë…„ë„ì— ë§Œë“¤ì–´ì¡Œìœ¼ë‹ˆ ì•„ì§ë„ v1ì´ ì•ˆë‚˜ì™”ë‹¤ã…‹ã…‹,,

ìœ„ì˜ ì½”ë“œë¥¼ ìµœì í™” í•´ë…¼ ëŠë‚Œì´ë¼ í•¨ê»˜ ì±… ë³´ì‹œì£µ
notifyComponents : https://github.com/facebookexperimental/Recoil/blob/main/packages/recoil/core/Recoil_RecoilRoot.js#L124

â†’ êµ¬ë…ì¤‘ì¸ ì»´í¬ë„ŒíŠ¸ì— ë³€ê²½ì„ ì „íŒŒ

getDownstreamNodes: https://github.com/facebookexperimental/Recoil/blob/main/packages/recoil/core/Recoil_FunctionalCore.js#L233

â†’ ì¢…ì†ëœ ë…¸ë“œë¥¼ ëª¨ë‘ ì°¾ìŒ

nodeToComponentSubscriptions : https://github.com/facebookexperimental/Recoil/blob/main/packages/recoil/core/Recoil_State.js#L91

â†’ Mapì— ì €ì¥ëœ ë…¸ë“œë¥¼ Keyë¡œ ì°¾ì•„ì„œ O(1)ë¡œ ì°¾ì„ ìˆ˜ ìˆìŒ

> Jotai

WeakMap(https://developer.mozilla.org/ko/docs/Web/JavaScript/Reference/Global_Objects/WeakMap) ì„ í™œìš©í•´ì„œ recoilì—ì„œ ë‹¨ì¼ keyë¥¼ ê°€ì ¸ì•¼í•˜ëŠ” atomì„ ê°œì„ í–ˆìŒ

> Zustand

ìš°ë¦¬ê°€ ì“°ê³  ìˆëŠ” ê±°ë‹ˆê¹ ì¢€ ë” ì‚´í´ë³´ì‹œì£µ

ìœ„ì— êµ¬í˜„í•œ ë°©ì‹ì²˜ëŸ¼ Zustandë„ ë°”ë‹ë¼jsë¡œ Storeë¥¼ êµ¬í˜„í–ˆë‹¤. ê·¸ë˜ì„œ reactì˜ ë Œë”ë§ì„ ì‹œì¼œì¤˜ì•¼í•˜ëŠ”ë° ./src/react.tsì—ì„œ ê´€ë¦¬ë˜ê³  ìˆëŠ” useStoreì™€ createê°€ ê·¸ ì—­í• ì„ í•´ì¤€ë‹¤

1. createStore : ë°”ë‹ë¼jsë¡œ ë§Œë“  ìŠ¤í† ì–´
2. create: reactì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ createStoreë¥¼ ë©í•‘í•˜ê³  useBoundStoreì˜ api ë¥¼ ë³µì‚¬í•´ì„œ ì‚¬ìš©í•¨
3. createWithEqualityFn : createì— ìƒíƒœ ë¹„êµ í•¨ìˆ˜ë¥¼ ì¶”ê°€í•˜ì—¬ ë¹„êµë¡œì§ì„ ì»¤ìŠ¤í…€ í•  ìˆ˜ ìˆìŒ

> [`create`](https://zustand.docs.pmnd.rs/apis/create) VS [`createWithEqualityFn`](https://zustand.docs.pmnd.rs/apis/create-with-equality-fn)

V4 ê¸°ì¤€ìœ¼ë¡œëŠ” `useStore` ì™€`useSyncExternalStoreWithSelector`ëŠ” íƒ€ì…ì´ ë‹¤ë¥´ê²Œ êµ¬í˜„ë˜ì—ˆì„ ë¿ êµ¬í˜„ì²´ëŠ” ë™ì¼í•©ë‹ˆë‹¤.

ë‹¤ë§Œ create ë˜ëŠ” ë¶€ë¶„ì—ì„œ `equalityFn` ê°’ì„ ê°•ì œí•˜ëƒê°€ ë‹¤ë¦…ë‹ˆë‹¤.

V5ì—ì„œëŠ” `useStore`ì— ë³€ê²½ì ì´ ìˆìŠµë‹ˆë‹¤.

1. `equalityFn` ë¥¼ ì œê±°

   ë³€ê²½ì´ìœ ëŠ” https://github.com/pmndrs/zustand/discussions/1937 ì—ì„œ í™•ì¸ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

2. ê¸°ì¡´ì˜ `useSyncExternalStoreWithSelector` ê°€ ì•„ë‹Œ createì˜ ë‚´ë¶€êµ¬í˜„ì— ì‚¬ìš©ëœ `useStore`ëŠ” `useSyncExternalStore` ë°˜í™˜
   - ë‘ í›…ì˜ ì°¨ì´ëŠ” ìŠ¤í† ì–´ ì „ì²´ë¥¼ ë¹„êµ í›„ ë¦¬ë Œë”ë§í•˜ëƒ, ì•„ë‹ˆë©´ ìŠ¤í† ì–´ì¤‘ íŠ¹ì • ê°’ì„ ë¹„êµí•˜ê³  ë¦¬ë Œë”ë§í•˜ëƒë¡œ ë³´ì¸ë‹¤. (`useSyncExternalStore`ë„ selectorë¥¼ propsë¡œ ë„˜ê²¨ì£¼ë©´ íŠ¹ì • ê°’ ë¹„êµê°€ ê°€ëŠ¥í•˜ì§€ë§Œ ì´ë¥¼ ë‚´ì¬í™” í•œ ëŠë‚Œ?? ì¢€ ë” ì•Œì•„ë´ì•¼í•  ê²ƒ ê°™ìŠµë‹ˆë‹¤,,,)

ê·¸ë¦¬ê³  ì´ê±´ ë³„ê°œì˜ ì´ì•¼ê¸°ì¸ë°
ê°œì¸ì ìœ¼ë¡œ ìƒíƒœë¥¼ ê´€ë¦¬í•˜ê¸° ìœ„í•´ ë´ì•¼í•˜ëŠ” ê³³ì´ ë§ì•„ì§„ë‹¤ëŠ” ë¬¸ì œê°€ ìƒê¸°ê¸° ë•Œë¬¸ì— ì „ì—­ ìƒíƒœê°€ ë§ì•„ì§€ëŠ”ê±´ ì¡°ì‹¬í•´ì•¼ í•œë‹¤ê³  ìƒê°í•©ë‹ˆë‹¤,,,

ì°¸ê³  :

1. https://www.epicreact.dev/one-react-mistake-thats-slowing-you-down
2. https://kentcdodds.com/blog/state-colocation-will-make-your-react-app-faster

# 6ì¥

## 6.3 ë¦¬ì•¡íŠ¸ ê°œë°œ ë„êµ¬ í™œìš©

### Components íƒ­

ì»´í¬ë„ŒíŠ¸ íŠ¸ë¦¬ë¥¼ í™•ì¸ ê°€ëŠ¥, propsì™€ ë‚´ë¶€ hookì— ëŒ€í•œ ì •ë³´ í™•ì¸ ê°€ëŠ¥

![image.png](/images/2024-09-30-2024-09-30-01/image.png)

componetsì˜ ë„êµ¬

1. ! : ê°•ì œ ì—ëŸ¬ ë°œìƒ
2. íƒ€ì´ë¨¸ : Suspenseë¡œ ê°ì‹¸ì ¸ ìˆëŠ” ì»´í¬ë„ŒíŠ¸ ë””ë²„ê¹… ìš©ì¸ë“¯??
3. ëˆˆ : í•´ë‹¹ ìš”ì†Œë¡œ ì´ë™
4. ë²Œë ˆ : ì»´í¬ë„ŒíŠ¸ ì„¸ë¶€ì‚¬í•­ ì½˜ì†”ì— ì°ì–´ì¤Œ
5. <> : ì†ŒìŠ¤ì½”ë“œ í™•ì¸ í•¨

### Profiler íƒ­

ë¦¬ì•¡íŠ¸ê°€ ë Œë”ë§í•˜ëŠ” ê³¼ì •ì—ì„œ ë°œìƒí•˜ëŠ” ìƒí™©ì„ í™•ì¸ í•˜ëŠ” ë„êµ¬ì´ë‹¤.

> ì„¤ì •

- General : 'Highlight updates when components render.' ì²´í¬í•˜ë©´ ë Œë”ë§ í‘œì‹œë¨
- Debugging : 'Hide logs during additional invocations in Strict Mode' ì²´í¬í•˜ë©´ strict Mode í•´ì œë¨
- Profiler : 'Record why each component rendered while profiling.â€™ ì²´í¬í•˜ë©´ ì»´í¬ë„ŒíŠ¸ê°€ ë Œë”ë§ ëœ ì´ìœ ë¥¼ ê¸°ë¡í•œë‹¤ â‡’ App ì†ë„ëŠ” ì¡°ê¸ˆ ëŠë ¤ì§€ì§€ë§Œ ë””ë²„ê¹…ì— í° ë„ì›€ì´ ëœë‹¤.

> Flamepraph

ë Œë” ì»¤ë°‹ë³„ë¡œ ì–´ë–¤ ì‘ì—…ì´ ë°œìƒí–ˆëŠ”ì§€ í‘œì‹œí•¨(ë„ˆë¹„ì™€ ë Œë”ë§ ì‹œê°„ì´ ë¹„ë¡€)

(ëœë”ë§ì´ ë˜ì§€ ì•Šì€ ì»´í¬ë„ŒíŠ¸ëŠ” íšŒìƒ‰ìœ¼ë¡œ í‘œì‹œë˜ê³  í˜¸ë²„í•˜ë©´ 'Did not render'ë¼ê³  ëœ¸)

> Ranked

í•´ë‹¹ ì»¤ë°‹ì—ì„œ ë Œë”ë§í•˜ëŠ” ë° ì˜¤ëœ ì‹œê°„ì´ ê±¸ë¦° ì»´í¬ë„ŒíŠ¸ë¥¼ ìˆœì„œëŒ€ë¡œ ë‚˜ì—´í•¨

(ë Œë”ë§ì´ ë°œìƒí•œ ì»´í¬ë„ŒíŠ¸ë§Œ ë³´ì—¬ì¤Œ)

> Timeline

ë Œë”ë§ì„ ì‹œê°„ì˜ ìˆœì„œëŒ€ë¡œ ë³´ì—¬ì¤Œ (react v18ì´ìƒë¶€í„°ë§Œ ê°€ëŠ¥)

## ex) í”„ë¡œíŒŒì¼ëŸ¬ë¡œ ë””ë²„ê¹… í•´ë³´ê¸°

### ë¬¸ì œ ìƒí™© -

`FeedStickyTabBar` ì»´í¬ë„ŒíŠ¸ê°€ ë Œë”ë§ ëœ ì´ìœ 

1. ì´ˆê¸° ë Œë”ë§
2. hook 27 changed
3. the parent component rendered

### ì›ì¸ ë¶„ì„

> ì´ˆê¸° ë Œë”ë§

ã…‡ã…‡ ë‹¹ì—°

> hook 27 changed

Components íƒ­ì—ì„œ `FeedStickyTabBar`ë¥¼ ì‚´í´ë³´ë©´ hook 27ì„ ì•Œ ìˆ˜ ìˆë‹¤.

ê·¼ë° 27ë²ˆì´ ì—†ë‹¤..???

ì„ì‹œë¡œ í…ŒìŠ¤íŠ¸ë¥¼ í•´ë´¤ë‹¤

```tsx
...
const [tmp, setTmp] = useState('ì´ë“ ')
...
 useEffect(function test() {
    setTimeout(() => setTmp('ì¬í›ˆ'), 1000)
  }, [])
...
```

ê·¸ ê²°ê³¼ dev toolsê°€ ê±°ì§“ë§ í•œ ê²ƒì„ ì•Œ ìˆ˜ ìˆì—ˆë‹¤

![image.png](/images/2024-09-30-2024-09-30-01/image%201.png)

![image.png](/images/2024-09-30-2024-09-30-01/image%202.png)

useEffectë¡œ setState í–ˆì„ ê²½ìš°

profiler â‡’ 21ë²ˆì§¸ í›…

componenets â‡’ 19ë²ˆì§¸ í›…

ê·¸ë˜ë„ ê·¼ì†Œí•œ ì°¨ì´ë¥¼ ë³´ë©´ `useGetOpacityTabScroll()` ë¥¼ ë¶ˆëŸ¬ì˜¤ë©´ì„œ 2ì´ ë°œìƒí–ˆì„ ê²ƒì´ë‹ˆ ì§ì ‘ í™•ì¸í•´ë³´ì

> the parent component rendered

`useGetOpacityTabScroll()`ì—ì„œ í•˜ë‚˜ì”© ë¹¼ë³´ë©´ ì›ì¸ì´ `useDeferredValue` ì„ì„ ì°¾ì•˜ë‹¤.

ìŠ¤í¬ë¡¤ ìœ„ì¹˜ì— ë”°ë¼ì„œ ë³€í•˜ëŠ” stateë¡œ ì¸í•œ ë Œë”ë§ì€ ì§€ì—°ì‹œê¸°í‚¤ ìœ„í•´ [useDeferredValue](https://ko.react.dev/reference/react/useDeferredValue)ì‚¬ìš©í–ˆì§€ë§Œâ€¦ ì‹¤íŒ¨í–ˆë‹¤. (ì›¹ìƒìœ¼ë¡œëŠ” ì˜ ì‘ë™í•˜ì§€ë§Œ ì•±ìœ¼ë¡œ í™•ì¸í•´ë³´ë©´ ë¹ ë°”ë°• ê±°ë¦¬ëŠ”ê²Œ ë³´ì¸ë‹¤. ~~ë Œë”ë§ì„ ì§€ì—°ì‹œí‚¨ë‹¤ëŠ” ê²ƒì€ ë Œë”ë§ ì‹œí‚¤ëŠ” cpuì„±ëŠ¥ì— ë”°ë¼ ë‹¤ë¥´ê²Œ ì‘ë™í•˜ëŠ” ê²ƒ ê°™ë‹¤~~ â‡’ ì•„ë‹ˆì—ˆë‹¤^^ ê·¸ëƒ¥ scrollTo ì´ë²¤íŠ¸ ì‹¤í–‰, state ì—…ë°ì´íŠ¸ íƒ€ì´ë° ì´ìŠˆì˜€ìŒ^^)

ë”°ë¼ì„œ ì œê±°í•´ì£¼ë©´ 2ë²ˆ ë Œë”ë§ ì´ìœ ë§Œ ë‚¨ëŠ”ë‹¤

ê·¸ë ‡ë‹¤ê³  í•´ê²°ì¸ ëœê²ƒì€ ì•„ë‹˜..

â‡’ [í•˜ì§€ë§Œ ì´ì œ ê·¹&ë½ğŸ˜](https://www.notion.so/117041301c1b803d853bdb73b0da6685?pvs=21)
